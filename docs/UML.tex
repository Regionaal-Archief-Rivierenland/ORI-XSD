\documentclass[margin={-40pt 15pt 15pt 15pt}]{standalone}

\usepackage{tikz}

\usepackage[kerning=true, tracking=true]{microtype}
\usepackage[dutch]{babel}

%% font stuff
\usepackage[lf]{MyriadPro}
%% math font for myriadpro
\usepackage{mdsymbol}
\usepackage[T1]{fontenc}

%% math symols
\usepackage{amsmath}
\usepackage{mathtools}

\usepackage{inconsolata}
%% computer modern monospace?
%% \usepackage[tt={oldstyle=false,variable=false}]{cfr-lm}


%% Color definitions
\usepackage[dvipsnames]{xcolor}
\definecolor{githubgrey}{HTML}{EAEEF2}
\definecolor{darkgreen}{HTML}{3D5E45}
\definecolor{purple}{HTML}{5C5573}
%% rounded boxes
\usepackage[most]{tcolorbox}

%% for templates
\usepackage{xparse}

\begin{document}

%% set default font to myriad pro
%% \renewcommand{\familydefault}{\sfdefault}
\sffamily

\usetikzlibrary{arrows}
\usetikzlibrary{calc}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{positioning}
%% needed for making svgs with white backgrounds
\usetikzlibrary{backgrounds}

%% TODO
%% - moeten verplichte relaties ook dik gedrukt?
%% - I think the arrow between vergadering and mediabron should be verplicht at least once
%% - make bestuurslaag a "GegevensGroupType" that recieves multiple arrows
%% - check if different number style in Myriad pro looks nice
%%   - not really
%% - try semi boldfont for Attribute names
%%   - too difficult with pdflatex
%% - maybe bullets instead of plusses? Making a proper list also gives more flexibility
%%    - all the more because the plusses serve little purposes

\newcommand\mystrut{\rule[-2.5pt]{0pt}{12pt}}
%% datatype typesetting
\newcommand{\datatype}[2][text]{%
    \tcbox[
      on line,
      boxsep=0pt,
      left=2.5pt,
      right=2.5pt,
      top=0pt,
      bottom=0pt,
      enlarge top initially by=-14pt,
      enlarge bottom by=-14pt,
      enlarge right by=-4pt,
      enlarge left by=-2pt,
      opacityframe=0,
      colback=githubgrey,
      fontupper={\ttfamily\mystrut},
      fontlower={\ttfamily\mystrut}]
      {\textcolor{black}{\textbf{#2}}}
}

\newcommand{\umltype}[1]{
  {\textbf{\textcolor{gray}{\guillemotleft#1\guillemotright}}}
}

%% Header of boxes
\newcommand{\objectheader}[2]{
  \umltype{#1} \\
  {\large \textbf{#2}}
  \nodepart[align=left]{two}
}

%% Attribute typesetting
\newcommand{\attribute}[3]{+ \; #1:\, \datatype{#2} \; {\figureversion{text}\textcolor{gray}{#3}}}

\newcommand{\keuze}[1]{\textcolor{darkgreen}{``#1''}}

\begin{tikzpicture}[
    background rectangle/.style={fill=white}, show background rectangle,
    %% not sure why the "header" is still centered after align=left, but oh well
    ORI object/.style={rectangle split, rectangle split parts=2,
      draw=black, rounded corners=5pt, very thick, inner sep=10pt},
    relatiepijl/.style={-{Straight Barb[length=4mm,width=6mm]}, very thick},
    gegevenspijl/.style={-{Straight Barb[length=4mm,width=6mm]}, very thick, dashed},
    kardinaliteit/.style={text=darkgray}, 
    align=center]
  
  \node (agendapunt) [ORI object, align=center]
        {
          \objectheader{Objecttype}{Agendapunt}

          \attribute{\textbf{ID}}{string}{} \\
          \attribute{Agendapunt omschrijving}{string}{[0..1]} \\
          \attribute{Gepland agendapuntvolgnummer}{string}{[0..1]} \\
          \attribute{Agendapuntvolgnummer}{string}{[0..1]} \\
          \attribute{Geplande starttijd}{datum + tijd}{[0..1]} \\
          \attribute{Geplande eindtijd}{datum + tijd}{[0..1]} \\
          \attribute{Starttijd}{datum + tijd}{[0..1]} \\
          \attribute{Eindtijd}{datum + tijd}{[0..1]} \\
          \attribute{Agendapunt kenmerk}{string}{[0..1]} \\
          \attribute{Agendapunt titel}{string}{[0..1]} \\
          \attribute{Indicatie hamerstuk}{boolean}{[0..1]} \\
          \attribute{Indicator behandeld}{boolean}{[0..1]} \\
          \attribute{\textbf{Indicator besloten}}{boolean}{} \\
          \attribute{Bestuurslaag}{bestuurslaagGegevens}{[0..1]}
        };


   \node (vergadering) [ORI object, align=center, left=6cm of agendapunt]
        {
          \objectheader{Objecttype}{Vergadering}

          \attribute{\textbf{ID}}{string}{} \\
          \attribute{Naam}{string}{[0..1]} \\
          \attribute{Vergadertoelichting}{string}{[0..1]} \\
          \attribute{Georganiseerd door gremium}{gremiumGegevens}{[0..1]} \\
          \attribute{\textbf{Vergaderingstype}}{\keuze{Raadsvergadering} | \keuze{Commissievergadering} | ...}{} \\
          \attribute{Locatie}{string}{[0..1]} \\
          \attribute{Status}{\keuze{Gepland} | \keuze{Gehouden} | \keuze{Geannuleerd}}{[0..1]} \\
          \attribute{Geplande vergaderdatum}{datum}{[0..1]} \\
          \attribute{Vergaderdatum}{datum}{[0..1]} \\
          \attribute{Geplande aanvang vergadering}{datum + tijd}{[0..1]} \\
          \attribute{Gepland einde vergadering}{datum + tijd}{[0..1]} \\
          \attribute{Aanvang vergadering}{datum + tijd}{[0..1]} \\
          \attribute{Einde vergadering}{datum + tijd}{[0..1]} \\
          \attribute{Publicatiedatum}{datum + tijd}{[0..1]} \\
          \attribute{Bestuurslaag}{bestuurslaagGegevens}{[0..1]}
        };

   \node (deelnemer) [ORI object, align=center, below=3.5cm of vergadering]
        {
          \objectheader{Objecttype}{Aanwezige deelnemer}

          \attribute{ID}{string}{} \\
          \attribute{\textbf{Rolnaam}}{\keuze{Voorzitter} | \keuze{Inspreker} | ...}{} \\
          \attribute{Organisatie}{string}{[0..1]} \\
          \attribute{Deelnemerspositie}{string}{[0..1]} \\
          \attribute{Aanvang aanwezigheid}{datum + tijd}{[0..1]} \\
          \attribute{Einde aanwezigheid}{datum + tijd}{[0..1]}
        };

        %% One could argue that this should just be another attribute
        \draw[relatiepijl] ($(vergadering.west)+(0,1.8)$)
        node [kardinaliteit, above, xshift = -0.4cm] {0..1} |-
        ($(vergadering.west)+(-3.0,1.8)$) |- ($(vergadering.west)+(-3.0,-1.8)$)
        node [fill=white, pos=0.25] {heeft als deelvergadering\\\umltype{relatiesoort}} --
        ($(vergadering.west)+(0,-1.8)$)
        node [kardinaliteit, above, xshift = -0.8cm] {0..*} ;

   \node (natuurlijkpersoon) [ORI object, align=center, left=4.0cm of deelnemer]
        {
          \objectheader{Objecttype}{Natuurlijk persoon}

          \attribute{\textbf{ID}}{string}{} \\
          \attribute{Geslachtsaanduiding}{\keuze{Man} | \keuze{Vrouw} | \keuze{Anders} | \keuze{Onbekend}}{[0..1]} \\
          \attribute{Functie}{\keuze{Burgermeester} | \keuze{Wethouder} | ...}{[0..1]} \\
          \attribute{\textbf{Naam}}{naamGegevens}{} \\
          \attribute{Nevenfunctie}{nevenfunctieGegevens}{[0..*]}
        };
        
   \node (mediabron) [ORI object, align=center, above=2.5cm of vergadering]
        {
          \objectheader{Objecttype}{Mediabron}

          \attribute{\textbf{ID}}{string}{} \\
          \attribute{Mimetype}{string}{[0..1]} \\
          \attribute{\textbf{Mediabron type}}{\keuze{Video} | \keuze{Audio} | \keuze{Transcriptie}}{} \\
          \attribute{URL}{URI}{[0..1]}
        };
        
  \node (stemming) [ORI object, below = 4cm of agendapunt, align=center]
        {
          \objectheader{Objecttype}{Stemming}

          \attribute{\textbf{ID}}{string}{} \\
          \attribute{Stemmingstype}{\keuze{Hoofdelijk} | \keuze{Regulier} | \keuze{Schriftelijk}}{[0..1]}\\
          \attribute{Resultaat mondelinge stemming}{\keuze{Voor} | \keuze{Tegen} | \keuze{Gelijk}}{[0..1]} \\
          \attribute{Toezegging}{string}{[0..1]} \\
          \attribute{Resultaat stemming over personen}{string}{[0..1]} \\
          \attribute{Stemming over personen}{stemmingOverPersonenGegevens}{[0..*]}
        };

  \node (besluit) [ORI object, above right = 0.5cm and 1.8cm of stemming, align=center]
        {
          \objectheader{Objecttype}{Besluit}

          \attribute{ID}{string}{[0..1]} \\
          \attribute{Besluit toelichting}{string}{[0..1]} \\
          \attribute{Toezegging}{string}{[0..1]} \\
          \attribute{\textbf{Besluit resultaat}}{\keuze{Unaniem aangenomen} | \keuze{Aangenomen} | ... }{}
        };

  \node (stemmingOverPersonenGegevens) [ORI object, right = 1.2cm of besluit, align=center, draw=gray]
        {
          \objectheader{Gegevensgroeptype}{Stemming over personen}

          \attribute{\textbf{Naam kandidaat}}{string}{} \\
          \attribute{\textbf{Aantal uitgebrachte stemmen}}{integer}{}
        };

        \node (informatieobject) [ORI object, align=center, above left = 7cm and -15.0cm of besluit]
        {
          \objectheader{Relatieklasse}{Informatieobject}
          \attribute{Informatieobject type}{\keuze{Motie} | \keuze{Antwoord} | ...}{[0..1]}
        };

  \node (mdto) [rectangle, draw, ultra thick, above right = 6cm and -0.5cm of stemmingOverPersonenGegevens, inner sep=50pt, double, double distance = 1cm, fill=githubgrey, align=center]
        {
          {\huge MDTO}
        };


        %% arrows
        %% FIXME: cardinalities won't be alligned, because pos= is relative to arrow length
        %% stemming -> agendapunt
        \draw [relatiepijl] (stemming) --
        node [anchor=center, fill=white] {heeft betrekking op\\\umltype{relatiesoort}}
        node [kardinaliteit, pos=0.08, right] {1..*}
        node [kardinaliteit, pos=0.81, xshift=0.03cm, right] {1} (agendapunt);
        %% stemming -> besluit
        \draw[relatiepijl] ($(stemming.north)+(2.5,0)$) |- (besluit.west)
        node [fill=white, pos=0.74, above] {leidt tot}
        node [fill=white, pos=0.74, below] {\umltype{relatiesoort}}
        node [kardinaliteit, pos=0.065, right] {0..*}
        node [kardinaliteit, above left, pos=0.95, yshift=-0.0cm] {0..1};
        %% stemming -> stemming over personen
        \draw[gegevenspijl] (stemming) -| (stemmingOverPersonenGegevens);
        %% stemming -> MDTO
        \draw[relatiepijl] ($(stemming.east)+(0,-1.3)$) -|
        node [pos=0.2, above] {heeft betrekking op}
        node [pos=0.2, below] {\umltype{relatiesoort}}
        coordinate[pos=0.85] (linestart3) % coordinate along the line
        ($(mdto.south)+(0,-0.5cm)$);

        \draw[dashed, very thick] (linestart3) -| (informatieobject);
        
        %% agendapunt -> vergadering
        \draw[relatiepijl] (agendapunt) -- (vergadering)
        node [fill=white, pos=0.5, above] {wordt behandeld tijdens}
        node [fill=white, pos=0.5, below] {\umltype{relatiesoort}}
        node [kardinaliteit, pos=0.05, above] {0..*}
        node [kardinaliteit, pos=0.9, above] {1};
        %% agendapunt -> MDTO
        \draw[relatiepijl] ($(agendapunt.east)-(0,2.0)$) -|
        node [pos=0.08, above] {heeft als bijlage}
        node [pos=0.08, below] {\umltype{relatiesoort}}
        coordinate[pos=0.14] (linestart2) % coordinate along the line
        ($(mdto.south)+(-1.5cm,-0.5cm)$);
        
        \draw[dashed, very thick] (linestart2) |- (informatieobject);

        %% mediabron -> MDTO
        \draw[relatiepijl] (mediabron)  -|
        node [pos=0.18, above] {hoort bij}
        node [pos=0.18, below] {\umltype{relatiesoort}}
        coordinate[pos=0.22] (linestart) % coordinate along the line
        ($(mdto.north)+(0cm,0.5cm)$);

        \draw[dashed, very thick] (linestart) |- (informatieobject.north west);
        
        %% vergadering -> mediabron
        \draw[relatiepijl] (vergadering)  -- 
        node [anchor=center, fill=white] {is vastgelegd middels\\\umltype{relatiesoort}} (mediabron);
        %% deelnemer -> vergadering
        \draw[relatiepijl] (deelnemer)  -- 
        node [anchor=center, fill=white] {neemt deel aan\\\umltype{relatiesoort}} (vergadering);
        %% deelnemer -> persoon
        \draw[relatiepijl] (deelnemer)  -- 
        node [fill=white, above] {is}
        node [fill=white, below] {\umltype{relatiesoort}}
        (natuurlijkpersoon);

\end{tikzpicture}

\end{document}
